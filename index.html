<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://dc-js.github.io/dc.js/css/dc.css" />
    <script src="https://dc-js.github.io/dc.js/js/d3.js"></script>
    <script src="https://dc-js.github.io/dc.js/js/crossfilter.js"></script>
    <script src="https://dc-js.github.io/dc.js/js/dc.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reductio/0.6.3/reductio.js"></script>
    <script src="https://npmcdn.com/universe@latest/universe.js"></script>
    <style>
        #content, html, body {
            height: 98%;
        }
        #script {
            float: left;
            width: 50%;
            height: 100%;
            overflow: scroll;
        }
        #visual {
            float: left;
            width: 50%;
            height: 50%;
        }
        #main-chart {
            float: right;
            width: 50%;
            height: 50%;
        }
        #fanwork {
            float: right;
            width: 50%;
            height: 43%;
            overflow: scroll;
        }
        .highlight {
            background-color: rgba(16, 96, 255, .5);
            font-weight: bold;
        }
        .match.intensity-0 {
            background-color: rgba(16, 96, 255, 0.65);
        }
        .match.intensity-1 {
            background-color: rgba(16, 96, 255, 0.55);
        }
        .match.intensity-2 {
            background-color: rgba(16, 96, 255, 0.45);
        }
        .match.intensity-3 {
            background-color: rgba(16, 96, 255, 0.35);
        }
        .match.intensity-4 {
            background-color: rgba(16, 96, 255, 0.25);
        }
        .match {
            background-color: rgba(16, 96, 255, 0.15);
        }
        .match.selected {
            background-color: rgba(224, 0, 0, 0.45);
            /* color: rgba(0, 0, 0, 1.0); */
        }
    </style>
    <script>

    </script>
</head>

<body>
    <div id="content">
    <script>

    </script>
    <div id="script"></div>
    <div id="characters" style="display: none">
Han Solo
(Queen) Leia
Luke Skywalker
Luke
Rey (Kira)
Finn
Kylo Ren
Poe Dameron
Rose
Chewbacca
C-3PO
<!--The--> General (Gleeson)
Uber (Serkis)
R2-D2
BB-8
Jedi
    </div>
    <div id="characters-minor" style="display: none">
        <!--Wounded Stormtrooper (Village)
        The Vicar
        Junk Dealer
        Junk Minion 1
        Snowtrooper #12 (Falcon)
        Salvage Station Bully (Desert Set)
        Scared Villager
        Captain Phasma
        Star Destroyer Colonel
        Rose’s Pub Barman (C049)
        Evil Castle Teach #1
        Brance (Rebel)
        Rebel 1 Major Ematt
        Rebel 2 Captain Trilla
        Rebel Admiral
        Evil Castle Officer #1
        Evil Castle Officer #2
        Gorwyn (Rebel Pilot)
        Rebel Pilot #1 (Duncan)
        Evil Castle Tech (Weapons)
        Stormtrooper #1 (Village)
        Star Destroyer Bridge Teach #2
        Stormtrooper 2 (Village)
        Gang member Mod #1
        Gang member Rocker #1
        “Bus Stop” Mother
        “Bus Stop” Son
        Lieutenant Mitaka
        Ruddo
        Emissary
        Naka (Flashback)
        Local Trader (Flashback)
        Young Luke Skywalker (Flashback)
        Stormtrooper #10
        Rebel Pilot
        Rebel Pilot N.N.
        Rebel Pilot #3
        Statura
        Rebel Tech #1
        Rebel Tech #2
        Captain Trilla
        Stormtrooper #11
        Stormtrooper #3 (Kylo Ren’s Request)
        Stormtrooper #5 (Woods)
        Snowtrooper #7 (Snow Steal)
        Stormtrooper #8 (Door to Ramparts)
        Evil Castle Tech (Scared)
        Star Destroyer Bridge Tech #1
        Star Destroyer Technician
        Evil Castle Tech #4
        Evil Castle Tech #5
        Salvage Station Bully 2
        Gang Member Rocker #2
        Rose’s Pub Patron #1
        Rose’s Pub Patron #2
        Rose’s Pub Patron #3
        Fat Cat (Flashback)
        Gangsters Mill
        Rebel Tech #3
        Dr. Kalonia
        Rebel Tech. #4-->
    </div>

    <div id="main-chart"></div>
    <div id="filter">
        <div id="dependent-selector"></div>
        <div id="text-search"></div>
        <div id="slider">
            <div id="input"></div>
            <div id="output"></div>
        </div>
    </div>
    <script>

        var chart = dc.barChart("#main-chart");
        d3.csv("data.csv", function(error, rawTable) {
            var meanAccessor = function(d) { return d.value.sum / d.value.count; };
            var countAccessor = function(d) { return d.value.count; };
            var sumAccessor = function(d) { return d.value.sum; };

            //d = key, i = value (both from data)

            //check if values are numbers
            //map function takes array and produces another array containing results
            //of executed callback function
            var likelyNumeric = function(table, key) {
                var samples = table.map(function(d) { return +d[key]; });
                // console.log(samples[0]); //output: 58
                // console.log(table[0]); //output: {SCRIPT_SECTION: "58", DISTANCE_TIER: "3", CHARACTER: "FINN", MATCH_COUNT: "4914"}
                for (var i = 0; i < samples.length; i++) {
                    if (isNaN(samples[i])) {
                        return false;
                    }
                }
                return true;
            }

            //use filter function?

            //reduce function sums up certain values of keys
            var reduceOnKey = function(dim, key) {
                return dim.group().reduce(
                    function(p, v) {
                        p.count += 1; p.sum += +v[key]; return p; },
                    function(p, v) {
                        p.count -= 1; p.sum -= +v[key]; return p; },
                    function() {
                        var p = {}; p.count = 0; p.sum = 0; return p; });
            };

            var reduceOnKeySubstring = function(dim, key, sub) {
                return dim.group().reduce(
                    function(p, v) {
                        p.count += 1;
                        p.sum += v[key].indexOf(sub) == -1 ? 0 : 1;
                        return p;
                    }, function(p, v) {
                        p.count -= 1;
                        p.sum -= v[key].indexOf(sub) == -1 ? 0 : 1;
                        return p;
                    }, function() {
                        var p = {}; p.count = 0; p.sum = 0; return p;
                    }
                );
            };

            //dimension defines a dimension
            //builds x axis based on what "key" is
            var independentAxis = function(table, chart, key, bin) {
                bin = bin || 100;

                var modifyAxis = function(d) {
                    return Math.floor(+d[key]/bin);
                }

                var dim = table.dimension(modifyAxis);
                //var hi = +dim.top(1)[0][key] + 1;
                //var lo = +dim.bottom(1)[0][key];
                var hi = modifyAxis(dim.top(1)[0])+1;
                var lo = modifyAxis(dim.bottom(1)[0]);
                chart.x(d3.scale.linear().domain([lo, hi]));
                chart.xAxisLabel(key);
                chart.xAxis().tickFormat(d3.format("d"));
                chart.dimension(dim);
                return dim;
            }

            var dependentAxis = function(dim, chart, key, sub) {
                sub = sub || "";

                var group;
                if (likelyNumeric(rawTable, key)) {
                    group = reduceOnKey(dim, key);
                } else {
                    group = reduceOnKeySubstring(dim, key, sub);
                }

                //reduce function sums up all matches (values) of keys at certain
                //script section
                var all = group.all().map(sumAccessor);
                // console.log(all);
                chart.y(d3.scale.linear().domain([0, d3.max(all)]));
                // console.log(d3.max(all));
                chart.yAxisLabel(key).group(group);
                chart.render();
            }

            chart.margins({top: 50, right: 50, bottom: 50, left: 50})
                 .brushOn(false)
                 .valueAccessor(sumAccessor)
                 .gap(0)
                 .on("renderlet.chart", function(chart) {
                     chart.selectAll('rect').on('click', function(d) {
                     //console.log(d.data.key);
                     var highlights = document.getElementsByClassName('highlight');
                     for (var c = 0; c < highlights.length; c++) {
                         highlights[c].setAttribute('class','script-section');
                     }
                     var currentSpan = document.getElementById('script-section-' + d.data.key);
                     currentSpan.scrollIntoView();
                     currentSpan.setAttribute('class','script-sections highlight');
                     })
                 });

            //crossfilter slices row-based data
            var cfTable = crossfilter(rawTable);
            var indepDim = independentAxis(cfTable, chart, "ORIGINAL_SCRIPT_WORD_INDEX");

            var keys = Object.keys(rawTable[0]);
            var sel = document.createElement("select");
            document.getElementById("dependent-selector").appendChild(sel);
            for (var k = 0; k < keys.length; k++) {
                var key = keys[k];
                sel.options[sel.options.length] = new Option(key, key);
            }
            sel.options[1].selected = true;

            sel.addEventListener("change", function() {
                dependentAxis(indepDim, chart, this.value);
            });

            var textBox = document.createElement("input");
            document.getElementById("text-search").appendChild(textBox);
            textBox.addEventListener("change", function() {
                dependentAxis(
                    indepDim,
                    chart,
                    sel.options[sel.selectedIndex].value,
                    this.value
                );
            });

            var slider = document.getElementById('input');
            var slideTest = document.createElement('input');
            slideTest.setAttribute('type','range');
            slideTest.setAttribute('min','5');
            slideTest.setAttribute('max','1000');
            slideTest.setAttribute('step','5');
            slideTest.setAttribute('value','100');
            slideTest.oninput = function () {
                console.log(this.value);
                var out = document.getElementById('output');
                out.innerHTML = 'Words per script section: ' + this.value;
                indepDim = independentAxis(cfTable, chart, "ORIGINAL_SCRIPT_WORD_INDEX",slideTest.value)
                dependentAxis(indepDim, chart, sel.options[sel.selectedIndex].value);
                indepDim.dispose();
            }
            slider.appendChild(slideTest);
            document.getElementById('output').innerHTML = 'Words per script section: ' + slideTest.value;

            //default chart rendered onload; 1 is positive match as y-axis
            dependentAxis(indepDim, chart, keys[1]);

            d3.csv('data.csv', function(data) {
                var binSize = 100;
                var wordCount =  data [(data.length-1)]["ORIGINAL_SCRIPT_WORD_INDEX"];
                //var sectionCount = data [(data.length-1)]["SCRIPT_SECTION"];
                var sectionCount = Math.floor(wordCount/binSize) + 1;
                var sectionedScript = document.getElementById('script');

                //for script formatting
                var punctuation  = [',', '.', '!', '?', '\''];
                var endpunctuation =  ['.', '!', '?'];
                var contractions = ['\'ve', '\'m', '\'ll', '\'re', '\'s', '\'t', 'n\'t', 'na'];
                var capitals = ['i'];
                var namesString = document.getElementById('characters').innerText;
                var namesList = namesString.split(/(\s+)/);

                for (var i = 0; i < sectionCount + 1; i++) {
                    var sectionSpan = document.createElement('span');
                    sectionSpan.setAttribute('class', 'script-sections');
                    sectionSpan.setAttribute('id', 'script-section-' + i);
                    sectionedScript.append(sectionSpan);
                }

                for (var j = 0; j < wordCount; j++) {
                    var selectedWord = data [j]["ORIGINAL_SCRIPT_WORD"];
                    //test for empty words
                    if (selectedWord == '') {
                        selectedWord = data [j]["LOWERCASE"];
                    }

                    var wordIndex = data [j]["ORIGINAL_SCRIPT_WORD_INDEX"];
                    var section = Math.floor(wordIndex / binSize);
                    //var section = data [j]["SCRIPT_SECTION"];
                    var selectedSpan = document.getElementById('script-section-' + section);

                    //speaker tags
                    if (j != 0 && (data [j]["CHARACTER"] != data [j-1]["CHARACTER"])) {
                        selectedSpan.append(document.createElement('br')); //add newline
                        selectedSpan.append(document.createTextNode(' ' + data [j]["CHARACTER"] + ': '));
                    }

                    //formatting
                    if (punctuation.includes(selectedWord) || contractions.includes(selectedWord)) {  //no space before punctuation
                        selectedSpan.append(document.createTextNode(selectedWord));
                    } else if (j != 0 && endpunctuation.includes(data [j-1]["ORIGINAL_SCRIPT_WORD"])) { //capitalize first word of sentence
                        selectedSpan.append(document.createTextNode(' ' + selectedWord[0].toUpperCase() + selectedWord.slice(1)));
                    } else if (capitals.includes(selectedWord) || j == 0) { //format things like 'i'
                        selectedSpan.append(document.createTextNode(' ' + selectedWord.toUpperCase()));
                    } else if (namesList.includes(selectedWord[0].toUpperCase() + selectedWord.slice(1))) { //format names
                        selectedSpan.append(document.createTextNode(' ' + selectedWord[0].toUpperCase() + selectedWord.slice(1)));
                    } else {
                        selectedSpan.append(document.createTextNode(' ' + selectedWord)); //all other words
                    }
                }
            });
        });
        </script>
        <div id="fanwork">
            <h1> Insert matches here </h1>
        </div>
        <script>

        </script>
        </div>

        </div>
</body>
